<!DOCTYPE html>
<html>
<head>
<!--
⣀⡀ ⢀⣀ ⢀⣀ ⡀⢀ ⢀⡀ ⣰⡀
⠇⠸ ⠣⠼ ⠣⠤ ⣑⡺ ⠣⠜ ⠘⠤

Copyright © 2013- nacyot<Daekwon Kim> All Rights Reserved.
-->
<meta content='text/html; charset=UTF-8' http-equiv='Content-Type'>
<meta content='target-densitydpi=device-dpi, width=device-width, maximum-scale=0.9, user-scalable=yes' name='viewport'>
<link href='/images/favicon.ico' rel='shortcut icon' type='image/x-icon'>
<link href='http://blog.nacyot.com/articles/2015-06-30-serverspec-with-docker/' rel='canonical'>
<link href='http://blog.nacyot.com/feed.xml' rel='alternate' title='nacyot의 프로그래밍 이야기 RSS Feed' type='application/rss+xml'>
<link href='/articles/2015-06-13-eunjeon-with-elasticsearch/' rel='prev' title='엘라스틱서치(elasticsearch)에 한글 형태소 분석기 은전한잎(eunjeon) 적용하기'>
<link href='/articles/2015-08-29-link-deckset/' rel='next' title='마크다운(Markdown) 기반 OSX 프레젠테이션 도구 덱셋(Deckset)'>
<meta content='Immutable Infrastructure와 컨테이너로 대표되는 도커(Docker)와 함께 서버 분야에 많은 변화를 가져온 것은 Configuration Management 도구들이었다. 쉐프(Chef), 퍼펫(Puppet), 앤서블(Ansible)로 대표되는 CM 툴들은 독자적인 DSL을 통해서 서버의 이상적인 상태와 그에 다다르는 과정을 선언적으로 기록한다. 그리고 이 기록을 통해서 원하는 서버의 특정 상태를 재현하게 도와준다. 이러한 흐름을 Infrastructure as Code라고 표현하기도 한다. 서버의 코드화, 여기서 한 단계 더 나아가면 또 다른 흥미로운 아이디어를 만나게된다. 서버가 코드라면 소프트웨어를 검증하는 기법들을 똑같이 적용할 수 있지 않을까?서버스펙(Serverspec)은 바로 이 질문에 대한 답을 보여주는 도구이다. 이 글에서는 Serverspec을 통해서 도커 이미지를 테스트하는 방법에 대해서 다룬다.' name='description'>
<link href='https://plus.google.com/+KimDaekwon' rel='author'>
<link href='https://plus.google.com/+KimDaekwon' rel='publisher'>
<meta content='summary' name='twitter:card'>
<meta content='article' property='og:type'>
<meta content='nacyot의 프로그래밍 이야기 :: Serverspec(서버스펙)을 통한 도커 이미지 테스트 자동화' name='twitter:title'>
<meta content='nacyot의 프로그래밍 이야기 :: Serverspec(서버스펙)을 통한 도커 이미지 테스트 자동화' property='og:title'>
<meta content='Immutable Infrastructure와 컨테이너로 대표되는 도커(Docker)와 함께 서버 분야에 많은 변화를 가져온 것은 Configuration Management 도구들이었다. 쉐프(Chef), 퍼펫(Puppet), 앤서블(Ansible)로 대표되는 CM 툴들은 독자적인 DSL을 통해서 서버의 이상적인 상태와 그에 다다르는 과정을 선언적으로 기록한다. 그리고 이 기록을 통해서 원하는 서버의 특정 상태를 재현하게 도와준다. 이러한 흐름을 Infrastructure as Code라고 표현하기도 한다. 서버의 코드화, 여기서 한 단계 더 나아가면 또 다른 흥미로운 아이디어를 만나게된다. 서버가 코드라면 소프트웨어를 검증하는 기법들을 똑같이 적용할 수 있지 않을까?서버스펙(Serverspec)은 바로 이 질문에 대한 답을 보여주는 도구이다. 이 글에서는 Serverspec을 통해서 도커 이미지를 테스트하는 방법에 대해서 다룬다.' name='twitter:description'>
<meta content='Immutable Infrastructure와 컨테이너로 대표되는 도커(Docker)와 함께 서버 분야에 많은 변화를 가져온 것은 Configuration Management 도구들이었다. 쉐프(Chef), 퍼펫(Puppet), 앤서블(Ansible)로 대표되는 CM 툴들은 독자적인 DSL을 통해서 서버의 이상적인 상태와 그에 다다르는 과정을 선언적으로 기록한다. 그리고 이 기록을 통해서 원하는 서버의 특정 상태를 재현하게 도와준다. 이러한 흐름을 Infrastructure as Code라고 표현하기도 한다. 서버의 코드화, 여기서 한 단계 더 나아가면 또 다른 흥미로운 아이디어를 만나게된다. 서버가 코드라면 소프트웨어를 검증하는 기법들을 똑같이 적용할 수 있지 않을까?서버스펙(Serverspec)은 바로 이 질문에 대한 답을 보여주는 도구이다. 이 글에서는 Serverspec을 통해서 도커 이미지를 테스트하는 방법에 대해서 다룬다.' property='og:description'>
<meta content='@nacyo_t' name='twitter:site'>
<meta content='nacyot의 프로그래밍 이야기' property='og:site_name'>
<meta content='http://blog.nacyot.com/articles/2015-06-30-serverspec-with-docker/' name='twitter:url'>
<meta content='http://blog.nacyot.com/articles/2015-06-30-serverspec-with-docker/' property='og:url'>
<meta content='http://i.imgur.com/MyCDEgF.jpg' name='twitter:image'>
<meta content='http://i.imgur.com/MyCDEgF.jpg' property='og:image'>
<meta content='devops, serverspec, rspec, test, infrastructure_as_code, docker, specinfra, guard, dockerfile, programming, infrastructure' name='keywords'>
<title>nacyot의 프로그래밍 이야기 :: Serverspec(서버스펙)을 통한 도커 이미지 테스트 자동화</title>
<link href="../../stylesheets/all.css" media="all" rel="stylesheet" type="text/css" />
<script src="../../javascripts/all.js" type="text/javascript"></script>
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-46785477-2', 'auto');
  ga('send', 'pageview');
</script>
</head>
<body>
<div class='categories' id='categories-title'>
<a href='/tags/news' title='새소식(News) 목록'>
<div class='category-news category-title' style='width: 12.5%'>
<i class='fa fa-newspaper-o'></i>
</div>
</a>
<a href='/tags/visualization' title='시각화(Visualization) 목록'>
<div class='category-title category-visualization' style='width: 12.5%'>
<i class='fa fa-bar-chart'></i>
</div>
</a>
<a href='/tags/infrastructure' title='시스템(Infrastructure) 목록'>
<div class='category-infrastructure category-title' style='width: 12.5%'>
<i class='fa fa-cloud'></i>
</div>
</a>
<a href='/tags/programming' title='프로그래밍(Programming) 목록'>
<div class='category-programming category-title' style='width: 12.5%'>
<i class='fa fa-desktop'></i>
</div>
</a>
<a href='/tags/software' title='소프트웨어(software) 목록'>
<div class='category-software category-title' style='width: 12.5%'>
<i class='fa fa-square-o'></i>
</div>
</a>
<a href='/tags/service' title='서비스(Services) 목록'>
<div class='category-service category-title' style='width: 12.5%'>
<i class='fa fa-cubes'></i>
</div>
</a>
<a href='/tags/editor' title='에디터(Editor) 목록'>
<div class='category-editor category-title' style='width: 12.5%'>
<i class='fa fa-edit'></i>
</div>
</a>
<a href='/tags/article' title='이야기(Articles) 목록'>
<div class='category-book category-title' style='width: 12.5%'>
<i class='fa fa-book'></i>
</div>
</a>
</div>
<div class='wall'>
<h1 class='title'>
<a href="/"><img alt='nacyot profile image' class='img-rounded profile_image' src='/images/nacyot.jpeg'>
<span class='hidden-sm hidden-xs'>
nacyot의 프로그래밍 이야기
</span>
</a>
</h1>
</div>

<div class='row'>
<div class='col-lg-2 col-md-2'></div>
<div class='col-lg-8 col-md-8 col-sm-12 col-xs-12'>
<div class='main'>
<div class='articles'>
<div class='article'>
<div class='categories'>
<div class='category category-programming-top' style='width: 50.0%'>
</div>
<div class='category category-infrastructure-top' style='width: 50.0%'>
</div>
</div>
<h1 class='title'>
<a href="./">Serverspec(서버스펙)을 통한 도커 이미지 테스트 자동화</a>
</h1>
<div>
<span class='date'>
<a href='/tags/programming' title='프로그래밍(Programming) 목록'>
<i class='fa fa-desktop' style='color: #1f77b4'></i>
프로그래밍
</a>
<a href='/tags/infrastructure' title='시스템(Infrastructure) 목록'>
<i class='fa fa-cloud' style='color: #2ca02c'></i>
시스템
</a>
<i class='fa fa-calendar'></i>
2015년 07월 07일 발행
</span>
</div>
<div class='title-image-wrapper'>
<img class="title-image" src="http://i.imgur.com/MyCDEgF.jpg" />
</div>
<a name='toc'></a>
<div class='toc'></div>
<div class='body'>
<p>Immutable Infrastructure와 컨테이너로 대표되는 도커(Docker)와 함께 서버 분야에 많은 변화를 가져온 것은 Configuration Management 도구들이었다. 쉐프(Chef), 퍼펫(Puppet), 앤서블(Ansible)로 대표되는 CM 툴들은 독자적인 DSL을 통해서 서버의 이상적인 상태와 그에 다다르는 과정을 선언적으로 기록한다. 그리고 이 기록을 통해서 원하는 서버의 특정 상태를 재현하게 도와준다. 이러한 흐름을 Infrastructure as Code라고 표현하기도 한다. 서버의 코드화, 여기서 한 단계 더 나아가면 또 다른 흥미로운 아이디어를 만나게된다. 서버가 코드라면 소프트웨어를 검증하는 기법들을 똑같이 적용할 수 있지 않을까?</p>

<p>서버스펙(Serverspec)은 바로 이 질문에 대한 답을 보여주는 도구이다. 이 글에서는 Serverspec을 통해서 도커 이미지를 테스트하는 방법에 대해서 다룬다.</p>



<h2><a name='서버스펙(serverspec)을-통한-도커-이미지-테스트'>서버스펙(Serverspec)을 통한 도커 이미지 테스트</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h2>

<p>이제 테스트 환경을 마련하고 실제로 테스트를 작성해보도록하자. 서버스펙에는 기본적으로 프로젝트를 초기화를 돕는 <code>serverspec-init</code>이라는 명령어가 포함되어있다. 여기서는 이 명령어를 사용하지 않고 진행한다. 먼저 루비의 기본적인 구조와 비슷하게 spec 디렉터리를 만들고 그 아래에 테스트 코드를 넣을 것이다.</p>
<div class="highlight"><pre><span id="line-1"><span class="o">./</span><span class="vg">serverspec</span><span class="o">-</span><span class="vg">with</span><span class="o">-</span><span class="vg">docker</span>
</span><span id="line-2"><span class="err">├──</span><span class="w"> </span><span class="vg">Gemfile</span>
</span><span id="line-3"><span class="err">└──</span><span class="w"> </span><span class="vg">spec</span>
</span><span id="line-4"><span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="vg">mongodb_image_spec</span><span class="o">.</span><span class="vg">rb</span>
</span><span id="line-5"><span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="vg">spec_helper</span><span class="o">.</span><span class="vg">rb</span>
</span></pre></div>
<p>디렉터리 구조는 아주 간단한다. 프로젝트 메인 디렉터리 아래에 spec 디렉터리를 만들고 테스트 설정 파일은 <code>spec_helper.rb</code>와 테스트 파일은 <code>mongodb_image_spec.rb</code>를 준비한다.</p>

<h3><a name='도커-이미지-준비'>도커 이미지 준비</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>여기서는 시스템에 도커가 설치되어있다고 가정한다(boot2docker도 무방하며, 실제로 이 글의 내용은 boot2docker를 통해서 테스트되었다). 도커를 통해서 nginx 공식 이미지를 다운로드 받는다.</p>
<div class="highlight"><pre><span id="line-1"><span class="nv">$ </span>docker pull nginx:latest
</span></pre></div>
<h3><a name='gemfile을-통한-의존성-관리'>Gemfile을 통한 의존성 관리</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>Serverspec을 통한 인프라 테스트는 루비를 기반으로 돌아간다(즉, 시스템에 루비가 설치되어있어야한다). 루비를 테스트를 위해 사용할 의존성 관리를 위해 프로젝트 루트에 다음과 같이 Gemfile을 작성한다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">source</span><span class="w"> </span><span class="s2">&quot;https://rubygems.org&quot;</span>
</span><span id="line-2">
</span><span id="line-3"><span class="err">`</span><span class="vg">gem</span><span class="w"> </span><span class="s2">&quot;3e,21ec&quot;</span>
</span><span id="line-4"><span class="vg">gem</span><span class="w"> </span><span class="s2">&quot;docker-api&quot;</span>
</span></pre></div>
<p>Gemfile은 프로젝트의 의존성을 관리하고, 프로젝트 내에서 사용될 실행 가능한 명령어들을 관리하기 위해 사용된다. 이제 의존성을 설치해보자.</p>
<div class="highlight"><pre><span id="line-1"><span class="nv">$ </span>bundle install
</span><span id="line-2">Fetching gem metadata from https://rubygems.org/.......
</span><span id="line-3">Resolving dependencies...
</span><span id="line-4">Using diff-lcs 1.2.5
</span><span id="line-5">Using excon 0.45.3
</span><span id="line-6">...
</span><span id="line-7">Using specinfra 2.36.6
</span><span id="line-8">Using serverspec 2.19.0
</span><span id="line-9">Using bundler 1.7.3
</span><span id="line-10">Your bundle is <span class="nb">complete</span>!
</span><span id="line-11">Use <span class="sb">`</span>bundle show <span class="o">[</span>gemname<span class="o">]</span><span class="sb">`</span> to see where a bundled gem is installed.
</span></pre></div>
<p>설치가 끝났으면 프로젝트 루트 아래에서 rspec 명령어가 작동하는지 테스트해보자.</p>
<div class="highlight"><pre><span id="line-1"><span class="nv">$ </span>bundle <span class="nb">exec </span>rspec --version
</span><span id="line-2">3.3.1
</span></pre></div>
<p>잘 동작한다!</p>

<h3><a name='spec_helper.rb'><code>spec_helper.rb</code></a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p><code>spec_helper.rb</code>는 프로젝트에 적용되는 RSpec 설정파일이다. <code>:host</code>에는 테스트에 사용할 적절한 도커 서버의 주소를 입력한다. <code>:docker_image</code>는 테스트할 대상을 의미하며, <code>:os</code>는 테스트 대상이 되는 서버의 운영체제를 의미한다. 서버스펙은 이 옵션을 통해서 테스트에서 사용하는 DSL을 추상화한다. <code>&lt;USERNAME&gt;</code>에는 적절한 사용자 이름을 넣어준다. 여기서는 OSX에서 boot2docker를 사용하고 있다고 가정하고 있으며 ssl key가 다른 곳에 있다면 적절한 위치를 지정해준다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;serverspec&#39;</span>
</span><span id="line-2"><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;docker&#39;</span>
</span><span id="line-3">
</span><span id="line-4"><span class="vg">set</span><span class="w"> </span><span class="o">:</span><span class="vg">backend</span><span class="p">,</span><span class="w"> </span><span class="c1">&#39;docker&#39;</span>
</span><span id="line-5"><span class="vg">set</span><span class="w"> </span><span class="o">:</span><span class="vg">host</span><span class="p">,</span><span class="w"> </span><span class="c1">&#39;https://192.168.59.103:2376&#39;</span>
</span><span id="line-6"><span class="vg">set</span><span class="w"> </span><span class="o">:</span><span class="vg">docker_image</span><span class="p">,</span><span class="w"> </span><span class="c1">&#39;tutum/mongodb&#39;</span>
</span><span id="line-7"><span class="vg">set</span><span class="w"> </span><span class="o">:</span><span class="vg">os</span><span class="p">,</span><span class="w"> </span><span class="nl">family:</span><span class="w"> </span><span class="o">:</span><span class="vg">ubuntu</span>
</span><span id="line-8">
</span><span id="line-9"><span class="vg">Docker</span><span class="o">.</span><span class="vg">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="line-10"><span class="w">  </span><span class="nl">client_cert:</span><span class="w"> </span><span class="c1">&#39;/Users/&lt;USERNAME&gt;/.boot2docker/certs/boot2docker-vm/cert.pem&#39;,</span>
</span><span id="line-11"><span class="w">  </span><span class="nl">client_key:</span><span class="w"> </span><span class="c1">&#39;/Users/&lt;USERNAME&gt;/.boot2docker/certs/boot2docker-vm/key.pem&#39;,</span>
</span><span id="line-12"><span class="w">  </span><span class="nl">ssl_ca_file:</span><span class="w"> </span><span class="c1">&#39;/Users/&lt;USERNAME&gt;/.boot2docker/certs/boot2docker-vm/ca.pem&#39;,</span>
</span><span id="line-13"><span class="w">  </span><span class="nl">scheme:</span><span class="w"> </span><span class="c1">&#39;https&#39;,</span>
</span><span id="line-14"><span class="w">  </span><span class="nl">read_timeout:</span><span class="w"> </span><span class="il">3600</span>
</span><span id="line-15"><span class="p">}</span>
</span><span id="line-16">
</span><span id="line-17"><span class="vg">Excon</span><span class="o">.</span><span class="vg">defaults</span><span class="p">[</span><span class="o">:</span><span class="vg">ssl_verify_peer</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="vg">false</span>
</span></pre></div>
<h3><a name='mongodb_image_spec.rb'><code>mongodb_image_spec.rb</code></a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>이 파일에는 테스트 코드를 작성한다. 테스트 코드는 RSpec 고유의 DSL로 작성되며, 서버스펙은 서버를 검증하기 위한 도구들을 제공한다. 아마 루비나 RSpec에 친숙하다면, 이 코드를 보고 어떤 내용인지 바로 알 수 있을 것이며, 안 써봤어도 직관적으로 이해할 수 있을 것이다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;spec_helper&#39;</span>
</span><span id="line-2">
</span><span id="line-3"><span class="vg">describe</span><span class="w"> </span><span class="c1">&#39;tutum/mongodb Image&#39; do</span>
</span><span id="line-4"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">file</span><span class="p">(</span><span class="c1">&#39;/etc&#39;) do</span>
</span><span id="line-5"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_directory</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-6"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-7">
</span><span id="line-8"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">process</span><span class="p">(</span><span class="c1">&#39;mongod&#39;) do</span>
</span><span id="line-9"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_running</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-10"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-11">
</span><span id="line-12"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">port</span><span class="p">(</span><span class="il">27017</span><span class="p">)</span><span class="w"> </span><span class="vg">do</span>
</span><span id="line-13"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_listening</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-14"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-15"><span class="vg">end</span>
</span></pre></div>
<p>여기에는 3개의 테스트가 기술되어있다. 서버스펙에서는 리소스라는 개념을 사용해서 테스트를 수행한다. 먼저 첫번째 테스트에서 쓰인 리소스는 <code>file</code>이다. 이를 통해서 <code>/etc</code>가 디렉터리인지 검증한다. 그 다음으로 두번째 테스트에서는 <code>process</code> 리소스를 통해서 <code>mongod</code> 프로세스가 실행중인지 검증한다. 마지막으로 <code>port</code> 리소스를 통해서 27017 포트가 대기중인지 검증한다. 서버스펙은 서버를 검증하기 위한 다양한 리소스를 제공하고 있으며 더 많은 리소스들에 대해서는 <a href="http://serverspec.org/resource_types.html">서버스펙 공식 사이트</a>에서 찾아볼 수 있다.</p>

<h3><a name='rspec으로-테스트-실행하기'>rspec으로 테스트 실행하기</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>이제 테스트 코드도 모두 작성했으니, 테스트가 정상적으로 작동하는지 검증하는 일만 남았다. 프로젝트 메인에서 테스트를 실행해보자.</p>
<div class="highlight"><pre><span id="line-1"><span class="nv">$ </span>rspec .
</span><span id="line-2">tutum/mongodb IMage
</span><span id="line-3">  File <span class="s2">&quot;/etc&quot;</span>
</span><span id="line-4">    should be directory
</span><span id="line-5">  Process <span class="s2">&quot;mongod&quot;</span>
</span><span id="line-6">    should be running
</span><span id="line-7">  Port <span class="s2">&quot;27017&quot;</span>
</span><span id="line-8">    should be listening
</span><span id="line-9">
</span><span id="line-10">Finished in 6.18 seconds <span class="o">(</span>files took 1.14 seconds to load<span class="o">)</span>
</span><span id="line-11"><span class="m">3</span> examples, <span class="m">0</span> failures
</span></pre></div>
<p>모든 테스트가 성공했다! 테스트를 통해서 <code>/etc</code> 디렉터리가 존재하고, <code>mongod</code> 프로세스가 실행되고 있으며, <code>27017</code> 포트가 대기중임을 알 수 있다.</p>

<h2><a name='테스트-주도-인프라스트럭처(test-driven-infrastructure)'>테스트 주도 인프라스트럭처(Test Driven Infrastructure)</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h2>

<p>여기까지 서버스펙을 통해서 이미 생성되어져 있는 도커 이미지를 검증하는 방법에 대해서 살펴보았다. 그렇다면 소프트웨어 개발과 마찬가지로 <code>Dockerfile</code>을 만드는 과정 전체를 테스트해보는 것은 어떨까?</p>

<p>물론 이것도 가능하다. 여기서는 redis 이미지를 직접 만들어가면서 테스트를 수행해보자.</p>

<h3><a name='디렉터리-구조'>디렉터리 구조</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>
<div class="highlight"><pre><span id="line-1"><span class="o">./</span><span class="vg">serverspec</span><span class="o">-</span><span class="vg">with</span><span class="o">-</span><span class="vg">docker</span>
</span><span id="line-2"><span class="err">├──</span><span class="w"> </span><span class="vg">Dockerfile</span>
</span><span id="line-3"><span class="err">├──</span><span class="w"> </span><span class="vg">Gemfile</span>
</span><span id="line-4"><span class="err">├──</span><span class="w"> </span><span class="vg">Guardfile</span>
</span><span id="line-5"><span class="err">└──</span><span class="w"> </span><span class="vg">spec</span>
</span><span id="line-6"><span class="w">    </span><span class="err">├──</span><span class="w"> </span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="vg">rb</span>
</span><span id="line-7"><span class="w">    </span><span class="err">└──</span><span class="w"> </span><span class="vg">spec_helper</span><span class="o">.</span><span class="vg">rb</span>
</span></pre></div>
<h3><a name='spec_helper.rb'><code>spec_helper.rb</code></a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>먼저 spec_helper.rb은 앞선 예제를 그대로 사용하되, 이미지 부분을 주석처리 한다.</p>
<div class="highlight"><pre><span id="line-1"><span class="c"># set :docker_image, &#39;nacyot/redis&#39;</span>
</span></pre></div>
<h3><a name='nacyot_redis_image_spec.rb'><code>nacyot_redis_image_spec.rb</code></a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>Redis 서버가 정상적으로 작동하는 지 확인하기 위한 테스트를 준비한다. </p>
<div class="highlight"><pre><span id="line-1"><span class="vg">require</span><span class="w"> </span><span class="c1">&#39;spec_helper&#39;</span>
</span><span id="line-2">
</span><span id="line-3"><span class="vg">describe</span><span class="w"> </span><span class="c1">&#39;nacyot/redis Image&#39; do</span>
</span><span id="line-4"><span class="w">  </span><span class="vg">before</span><span class="p">(</span><span class="o">:</span><span class="vg">all</span><span class="p">)</span><span class="w"> </span><span class="vg">do</span>
</span><span id="line-5"><span class="w">    </span><span class="vg">image</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">Docker:</span><span class="o">:</span><span class="vg">Image</span><span class="o">.</span><span class="vg">build_from_dir</span><span class="p">(</span><span class="c1">&#39;.&#39;);</span>
</span><span id="line-6"><span class="w">    </span><span class="vg">set</span><span class="w"> </span><span class="o">:</span><span class="vg">docker_image</span><span class="p">,</span><span class="w"> </span><span class="vg">image</span><span class="o">.</span><span class="vg">id</span>
</span><span id="line-7"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-8">
</span><span id="line-9"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">file</span><span class="p">(</span><span class="c1">&#39;/etc&#39;) do</span>
</span><span id="line-10"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_directory</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-11"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-12">
</span><span id="line-13"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">package</span><span class="p">(</span><span class="c1">&#39;redis-server&#39;) do</span>
</span><span id="line-14"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_installed</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-15"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-16">
</span><span id="line-17"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">file</span><span class="p">(</span><span class="c1">&#39;/usr/local/bin/redis-server&#39;) do</span>
</span><span id="line-18"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_executable</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-19"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-20">
</span><span id="line-21"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">process</span><span class="p">(</span><span class="c1">&#39;redis-server&#39;) do</span>
</span><span id="line-22"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_running</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-23"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-24">
</span><span id="line-25"><span class="w">  </span><span class="vg">describe</span><span class="w"> </span><span class="vg">port</span><span class="p">(</span><span class="il">6379</span><span class="p">)</span><span class="w"> </span><span class="vg">do</span>
</span><span id="line-26"><span class="w">    </span><span class="vg">it</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be_listening</span><span class="w"> </span><span class="p">}</span>
</span><span id="line-27"><span class="w">  </span><span class="vg">end</span>
</span><span id="line-28"><span class="vg">end</span>
</span></pre></div>
<p>여기서 작성한 테스트들 역시 기본적인 rspec 문법으로 작성되었으며 서버스펙의 리소스들을 사용하고 있다.</p>

<p>주목할만한 부분이 있다. 이전에는 없었던 <code>before(:all)</code> 절이 추가되었는데, 이 부분은 테스트를 실행하기에 앞서 한 번 실행된다. 여기서 하는 일은 프로젝트 루트의 <code>Dockerfile</code>로부터 도커 이미지를 생성하고, 테스트 대상 이미지를 동적으로 지정하는 일이다(이 때 이미지 이름이 아니라, 빌드로부터 반환되는 이미지 ID를 사용한다). 이를 통해서 별도로 빌드 명령을 수행하지 않아도, 테스트를 수행할 때마다 자동적으로 빌드를 하고 테스트를 수행한다.</p>

<h3><a name='guard를-통한-자동테스트'>Guard를 통한 자동테스트</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>이번 프로젝트에서는 Guard를 통해서 Dockerfile과 spec 파일의 변경을 감지하고 테스트할 수 있도록 한다. 이를 위해 Gemfile을 다음과 같이 수정한다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">source</span><span class="w"> </span><span class="c1">&#39;https://rubygems.org&#39;</span>
</span><span id="line-2">
</span><span id="line-3"><span class="vg">gem</span><span class="w"> </span><span class="c1">&#39;serverspec&#39;</span>
</span><span id="line-4"><span class="vg">gem</span><span class="w"> </span><span class="c1">&#39;docker-api&#39;</span>
</span><span id="line-5"><span class="vg">gem</span><span class="w"> </span><span class="c1">&#39;guard&#39;</span>
</span><span id="line-6"><span class="vg">gem</span><span class="w"> </span><span class="c1">&#39;guard-rspec&#39;</span>
</span></pre></div>
<p>프로젝트 루트에서 추가한 의존성을 설치해준다.</p>
<div class="highlight"><pre><span id="line-1"><span class="nv">$ </span>bundle
</span></pre></div>
<p>그리고 아래와 같이 Guardfile을 작성한다.</p>
<div class="highlight"><pre><span id="line-1"><span class="n">guard</span> <span class="o">:</span><span class="n">rspec</span><span class="o">,</span> <span class="n">cmd</span><span class="o">:</span> <span class="s2">&quot;bundle exec rspec&quot;</span> <span class="k">do</span>
</span><span id="line-2">  <span class="n">require</span> <span class="s1">&#39;guard/rspec/dsl&#39;</span>
</span><span id="line-3">  <span class="n">watch</span><span class="o">(</span><span class="n">Guard</span><span class="o">::</span><span class="n">RSpec</span><span class="o">::</span><span class="n">Dsl</span><span class="o">.</span><span class="na">new</span><span class="o">(</span><span class="n">self</span><span class="o">).</span><span class="n">rspec</span><span class="o">.</span><span class="na">spec_files</span><span class="o">)</span>
</span><span id="line-4">  <span class="n">watch</span><span class="o">(%</span><span class="n">r</span><span class="o">{^</span><span class="n">Dockerfile$</span><span class="o">})</span> <span class="o">{</span> <span class="s1">&#39;spec/nacyot_redis_image_spec.rb&#39;</span> <span class="o">}</span>
</span><span id="line-5"><span class="n">end</span>
</span></pre></div>
<p>이 Guard 파일의 내용은 spec 디렉터리 아래의 파일이나 dockerfile이 변경되었을 때 테스트를 자동적으로 실행하도록 한다.</p>

<p>이제 별도의 터미널을 실행해서 프로젝트 루트에서 다음 명령어를 실행하면 파일이 변경될 때마다 테스트가 자동적으로 실행된다.</p>
<div class="highlight"><pre><span id="line-1"><span class="err">#</span><span class="w"> </span><span class="vg">bundle</span><span class="w"> </span><span class="vg">exec</span><span class="w"> </span><span class="vg">guard</span>
</span><span id="line-2"><span class="nl">09</span><span class="o">:</span><span class="il">47</span><span class="o">:</span><span class="il">59</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="vg">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nl">Guard:</span><span class="o">:</span><span class="vg">RSpec</span><span class="w"> </span><span class="vg">is</span><span class="w"> </span><span class="vg">running</span>
</span><span id="line-3"><span class="nl">09</span><span class="o">:</span><span class="il">47</span><span class="o">:</span><span class="il">59</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="vg">INFO</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="vg">Guard</span><span class="w"> </span><span class="vg">is</span><span class="w"> </span><span class="vg">now</span><span class="w"> </span><span class="vg">watching</span><span class="w"> </span><span class="vg">at</span><span class="w"> </span><span class="c1">&#39;/Users/.../docker-with-serverspec&#39;</span>
</span><span id="line-4"><span class="p">[</span><span class="il">1</span><span class="p">]</span><span class="w"> </span><span class="vg">guard</span><span class="p">(</span><span class="vg">main</span><span class="p">)</span><span class="o">&gt;</span>
</span></pre></div>
<h3><a name='첫번째-이터레이션-:-이미지-생성하기'>첫번째 이터레이션 : 이미지 생성하기</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>먼저 빈 Dockerfile을 만들고 베이스 이미지를 지정해준다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">FROM</span><span class="w"> </span><span class="nl">ubuntu:</span><span class="mf">14.04</span>
</span></pre></div>
<p>Guard에서 이 변화를 알아채고 자동적으로 테스트를 수행할 것이다. 앞서 이야기했듯이 테스트가 실행되면 자동적으로 이미지가 빌드되므로 빌드는 별도로 수행하지 않아도 된다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span>
</span><span id="line-2"><span class="w">  </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/etc&quot;</span>
</span><span id="line-3"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">directory</span>
</span><span id="line-4"><span class="w">  </span><span class="vg">Package</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span>
</span><span id="line-5"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">installed</span><span class="w"> </span><span class="p">(</span><span class="vg">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="il">1</span><span class="p">)</span>
</span><span id="line-6"><span class="w">  </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/usr/bin/redis-server&quot;</span>
</span><span id="line-7"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">executable</span><span class="w"> </span><span class="p">(</span><span class="vg">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="il">2</span><span class="p">)</span>
</span><span id="line-8"><span class="w">  </span><span class="vg">Process</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span>
</span><span id="line-9"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">running</span><span class="w"> </span><span class="p">(</span><span class="vg">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="il">3</span><span class="p">)</span>
</span><span id="line-10"><span class="w">  </span><span class="vg">Port</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span>
</span><span id="line-11"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">listening</span><span class="w"> </span><span class="p">(</span><span class="vg">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="il">4</span><span class="p">)</span>
</span><span id="line-12">
</span><span id="line-13"><span class="vg">Finished</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="mf">5.23</span><span class="w"> </span><span class="vg">seconds</span><span class="w"> </span><span class="p">(</span><span class="vg">files</span><span class="w"> </span><span class="vg">took</span><span class="w"> </span><span class="mf">0.30381</span><span class="w"> </span><span class="vg">seconds</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">load</span><span class="p">)</span>
</span><span id="line-14"><span class="nl">5</span><span class="w"> </span><span class="vg">examples</span><span class="p">,</span><span class="w"> </span><span class="il">4</span><span class="w"> </span><span class="vg">failures</span>
</span><span id="line-15">
</span><span id="line-16"><span class="vg">Failed</span><span class="w"> </span><span class="nl">examples:</span>
</span><span id="line-17">
</span><span id="line-18"><span class="vg">rspec</span><span class="w"> </span><span class="o">./</span><span class="vg">spec</span><span class="o">/</span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="nl">rb:</span><span class="il">14</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span><span class="w"> </span><span class="vg">Package</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">installed</span>
</span><span id="line-19"><span class="vg">rspec</span><span class="w"> </span><span class="o">./</span><span class="vg">spec</span><span class="o">/</span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="nl">rb:</span><span class="il">18</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span><span class="w"> </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/usr/bin/redis-server&quot;</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">executable</span>
</span><span id="line-20"><span class="vg">rspec</span><span class="w"> </span><span class="o">./</span><span class="vg">spec</span><span class="o">/</span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="nl">rb:</span><span class="il">22</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span><span class="w"> </span><span class="vg">Process</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">running</span>
</span><span id="line-21"><span class="vg">rspec</span><span class="w"> </span><span class="o">./</span><span class="vg">spec</span><span class="o">/</span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="nl">rb:</span><span class="il">26</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span><span class="w"> </span><span class="vg">Port</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">listening</span>
</span></pre></div>
<p>첫번째 테스트만 성공하고, 나머지 테스트가 실패했다! </p>

<h3><a name='두번째-이터레이션-:-apt-get을-통해서-redis-설치하기'>두번째 이터레이션 : apt-get을 통해서 redis 설치하기</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>Dockerfile 뒤에 다음 내용을 추가한다.</p>
<div class="highlight"><pre><span id="line-1"><span class="kr">RUN</span><span class="w"> </span><span class="vg">sed</span><span class="w"> </span><span class="o">-</span><span class="vg">i</span><span class="w"> </span><span class="c1">&#39;s/archive.ubuntu.com/ftp.daum.net/g&#39; /etc/apt/sources.list</span>
</span><span id="line-2">
</span><span id="line-3"><span class="kr">RUN</span><span class="w"> </span><span class="o">\</span>
</span><span id="line-4"><span class="w">  </span><span class="vg">apt</span><span class="o">-</span><span class="vg">get</span><span class="w"> </span><span class="vg">update</span><span class="w"> </span><span class="o">&amp;&amp;\</span>
</span><span id="line-5"><span class="w">  </span><span class="vg">apt</span><span class="o">-</span><span class="vg">get</span><span class="w"> </span><span class="vg">install</span><span class="w"> </span><span class="o">-</span><span class="vg">y</span><span class="w"> </span><span class="vg">redis</span><span class="o">-</span><span class="vg">server</span>
</span></pre></div>
<p>자동적으로 테스트가 실행된다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span>
</span><span id="line-2"><span class="w">  </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/etc&quot;</span>
</span><span id="line-3"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">directory</span>
</span><span id="line-4"><span class="w">  </span><span class="vg">Package</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span>
</span><span id="line-5"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">installed</span>
</span><span id="line-6"><span class="w">  </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/usr/bin/redis-server&quot;</span>
</span><span id="line-7"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">executable</span>
</span><span id="line-8"><span class="w">  </span><span class="vg">Process</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span>
</span><span id="line-9"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">running</span><span class="w"> </span><span class="p">(</span><span class="vg">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="il">1</span><span class="p">)</span>
</span><span id="line-10"><span class="w">  </span><span class="vg">Port</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span>
</span><span id="line-11"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">listening</span><span class="w"> </span><span class="p">(</span><span class="vg">FAILED</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="il">2</span><span class="p">)</span>
</span><span id="line-12">
</span><span id="line-13"><span class="vg">Finished</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="mf">7.42</span><span class="w"> </span><span class="vg">seconds</span><span class="w"> </span><span class="p">(</span><span class="vg">files</span><span class="w"> </span><span class="vg">took</span><span class="w"> </span><span class="mf">0.29263</span><span class="w"> </span><span class="vg">seconds</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">load</span><span class="p">)</span>
</span><span id="line-14"><span class="nl">5</span><span class="w"> </span><span class="vg">examples</span><span class="p">,</span><span class="w"> </span><span class="il">2</span><span class="w"> </span><span class="vg">failures</span>
</span><span id="line-15">
</span><span id="line-16"><span class="vg">Failed</span><span class="w"> </span><span class="nl">examples:</span>
</span><span id="line-17">
</span><span id="line-18"><span class="vg">rspec</span><span class="w"> </span><span class="o">./</span><span class="vg">spec</span><span class="o">/</span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="nl">rb:</span><span class="il">22</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span><span class="w"> </span><span class="vg">Process</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">running</span>
</span><span id="line-19"><span class="vg">rspec</span><span class="w"> </span><span class="o">./</span><span class="vg">spec</span><span class="o">/</span><span class="vg">nacyot_redis_image_spec</span><span class="o">.</span><span class="nl">rb:</span><span class="il">26</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span><span class="w"> </span><span class="vg">Port</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span><span class="w"> </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">listening</span>
</span></pre></div>
<p>redis-server 패키지의 설치를 검증하는 두번째, 세번째 테스트도 통과했다!</p>

<h3><a name='세번째-이터레이션-:-redis-실행하기'>세번째 이터레이션 : redis 실행하기</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>Dockerfile 뒤에 다음 내용을 추가해준다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">CMD</span><span class="w"> </span><span class="vg">redis</span><span class="o">-</span><span class="vg">server</span>
</span></pre></div>
<p>이번에도 자동적으로 테스트가 실행된다.</p>
<div class="highlight"><pre><span id="line-1"><span class="vg">nacyot</span><span class="o">/</span><span class="vg">redis</span><span class="w"> </span><span class="vg">Image</span>
</span><span id="line-2"><span class="w">  </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/etc&quot;</span>
</span><span id="line-3"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">directory</span>
</span><span id="line-4"><span class="w">  </span><span class="vg">Package</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span>
</span><span id="line-5"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">installed</span>
</span><span id="line-6"><span class="w">  </span><span class="vg">File</span><span class="w"> </span><span class="s2">&quot;/usr/bin/redis-server&quot;</span>
</span><span id="line-7"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">executable</span>
</span><span id="line-8"><span class="w">  </span><span class="vg">Process</span><span class="w"> </span><span class="s2">&quot;redis-server&quot;</span>
</span><span id="line-9"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">running</span>
</span><span id="line-10"><span class="w">  </span><span class="vg">Port</span><span class="w"> </span><span class="s2">&quot;6379&quot;</span>
</span><span id="line-11"><span class="w">    </span><span class="vg">should</span><span class="w"> </span><span class="vg">be</span><span class="w"> </span><span class="vg">listening</span>
</span><span id="line-12">
</span><span id="line-13"><span class="vg">Finished</span><span class="w"> </span><span class="vg">in</span><span class="w"> </span><span class="mf">6.94</span><span class="w"> </span><span class="vg">seconds</span><span class="w"> </span><span class="p">(</span><span class="vg">files</span><span class="w"> </span><span class="vg">took</span><span class="w"> </span><span class="mf">0.29334</span><span class="w"> </span><span class="vg">seconds</span><span class="w"> </span><span class="vg">to</span><span class="w"> </span><span class="vg">load</span><span class="p">)</span>
</span><span id="line-14"><span class="nl">5</span><span class="w"> </span><span class="vg">examples</span><span class="p">,</span><span class="w"> </span><span class="il">0</span><span class="w"> </span><span class="vg">failures</span>
</span></pre></div>
<p>테스트가 모두 통과했다! 이를 통해 이 이미지로부터 레디스(redis) 서버가 정상적으로 실행되는 것을 보장할 수 있다.</p>

<h3><a name='테스트-코드'>테스트 코드</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h3>

<p>여기서 사용한 프로젝트와 테스트 코드는 <a href="https://github.com/nacyot/serverspec_tutorial">serverspec_tutorial</a>에서 확인할 수 있다.</p>

<h2><a name='결론'>결론</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h2>

<p>인프라가 정상적인 상태에 있다는 것을 증명하는 것은 매우 중요한 주제이다. 그럼에도 불구하고 이러한 테스트는 대부분 자동화되어있지 않다. Serverspec은 원래 ssh를 통해서 서버의 상태나 CM 툴과 함께 사용을 목적으로 만들어진 도구이다. 이 훌륭한 도구는 단순히 기존 서버 환경 뿐만 아니라 빌드를 통해 완성된 이미지를 구성하는 도커와 같은 컨테이너 시스템을 테스트하는 데도 적격이다. 이를 통해 소프트웨어 테스트 뿐만 아니라 소프트웨어를 탑재한 이미지가  배포되기 전에 정상적으로 작동하는지, 필요한 파일들을 제대로 포함하고 있는지까지 함께 검증하는 것이 가능하다. 또한 서버가 코드처럼 다뤄질 수 있다면, 테스트 자동화는 물론 저장소와 연동해서 CI를 통해 지속적인 통합 역시 가능해진다.</p>

<p>이제 딱딱해 보이고 하드웨어에 더 가깝게 취급되던 인프라가 이제 정말로 소프트웨어 영역에 좀 더 가까워지고 있다.</p>

<h2><a name='보충'>보충</a> <span class='to_toc'><a href='#toc'><i class='fa fa-angle-double-up'></i></a></span></h2>

<p>테스트 과정에서 도커 공식 이미지에서 주로 이용되는 debian 환경에 대해서는 포트 리스닝 테스트가 정상적으로 작동하지 않았다. 아직 일부 환경에서 몇몇 리소스들이 정상적으로 작동하지 않을 가능성이 있다. 다음 글에서는 서버스펙에서 도커 테스트가 어떻게 실행되는 지 살펴본다.</p>

</div>
<div class='recommand'>
<strong>
이 글이 도움이 되셨나요?
</strong>
<div class='links'>
<div class='feedly'>
<a href='http://feedly.com/i/subscription/feed/http://blog.nacyot.com/feed.xml'>
<img id='feedlyFollow' style='display:inline;' src='http://s3.feedly.com/img/follows/feedly-follow-logo-green_2x.png' alt='follow us in feedly' width='20' height='20' />
Feedly에서 nacyot의 프로그래밍 이야기 구독하기
</a>
</div>
<div class='twitter'>
<a href='https://twitter.com/intent/follow?screen_name=nacyo_t' target='_blank'>
<img style='display: inline' width='20' height='20' src='/images/twitter.png' />
Twitter에서 nacyot 팔로우하기
</a>
</div>
</div>
</div>
<div class='footer'>
<hr>
<div class='row'>
<div class='col-lg-12 col-md-12 col-sm-12 col-xs-12'>
<div class='tags'>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/devops'>
데브옵스(devops)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/docker'>
도커(Docker)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/dockerfile'>
dockerfile
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/guard'>
가드(Guard)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/infrastructure'>
시스템(Infrastructure)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/infrastructure_as_code'>
infrastructure as code
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/programming'>
프로그래밍(Programming)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/rspec'>
RSpec
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/serverspec'>
서버스펙(Serverspec)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/specinfra'>
스펙인프라(Specinfra)
<span class='more'>
더 보기
</span>
</a>
</div>
<div>
<i class='fa fa-tag'></i>
<a href='/tags/test'>
테스트(test)
<span class='more'>
더 보기
</span>
</a>
</div>
</div>
</div>
</div>
<hr>
<div class='row'>
<div class='author col-lg-6 col-md-6 col-sm-6 col-xs-6'>
<h1>nacyot</h1>
프로그래머
</div>
<div class='share col-lg-6 col-md-6 col-sm-6 col-xs-6'>
<h1>Share this post</h1>
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_32x32_style">
<a class="addthis_button_facebook"></a>
<a class="addthis_button_twitter"></a>
<a class="addthis_button_google_plusone_share"></a>
<a class="addthis_button_pocket"></a>
<a class="addthis_button_print"></a>
<a class="addthis_button_compact"></a><a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript">var addthis_config = {"data_track_addressbar":false};</script>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-52ffce6f41e2b5e2"></script>
<!-- AddThis Button END -->
</div>
</div>
</div>
<hr>
<div id='disqus_thread'>
<script>
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'nacyot'; // required: replace example with your forum shortname
  
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</div>
<div class='barcode' data-title='Serverspec(서버스펙)을 통한 도커 이미지 테스트 자동화'></div>
<div class='navigation'>
<div class='prevnav'>
<div class='fa fa-chevron-left'></div>
<div class='fa fa-chevron-left'></div>
<div class='fa fa-chevron-left'></div>
<a href='/articles/2015-06-13-eunjeon-with-elasticsearch/' rel='prev'>이전 글</a>
<div class='summary_card'>
<div class='categories'>
<div class='category category-programming-top' style='width: 100.0%'></div>
</div>
<h1 class='title'>
<a href="../2015-06-13-eunjeon-with-elasticsearch/">엘라스틱서치(elasticsearch)에 한글 형태소 분석기 은전한잎(eunjeon) 적용하기</a>
</h1>
<div>
<span class='date'>
<a href='/tags/programming' title='프로그래밍(Programming) 목록'>
<i class='fa fa-desktop' style='color: #1f77b4'></i>
프로그래밍
</a>
<i class='fa fa-calendar'></i>
2015년 06월 13일 발행
</span>
</div>
<div class='summary'>
<div class='title-image-wrapper'>
<img class="title-image" src="http://i.imgur.com/DxnlLeu.jpg" />
</div>
<p>엘라스틱(elastic)에서 개발한 엘라스틱서치(elasticsearch)는 루씬 기반의 검색 서버이다. 설치도 간편하며 기본 설정으로 사용해도 충분히 강력하지만 기본적으로 한국어 분석을 지원하지 않는다. 예를 들어 &quot;아버지가 방에 들어간다&quot;라는 한국어 문장을 인덱스해도 &quot;아버지&quot;로는 검색이 안 되고, 반드시 &quot;아버지가&quot;로 검색해야만 결과에 출력된다. 이는 엘라스틱서치의 기본 토크나이저가 공백이나 특수문자만으로 단어들을 분리하기 때문이다. 이러한 문제를 해결하기 위해서는 n-gram 분석이나, 형태소 분석과 같은 인덱스를 추가로 지원해야한다. 이 글에서는 일본어 형태소 분석기 mecab를 한국어에 맞춰 수정한 은전한잎(mecab-ko)을 통해 엘라스틱서치에서 한국어를 인덱스하는 방법에 대해서 다룬다.</p>

<span class='link'>
<a href="../2015-06-13-eunjeon-with-elasticsearch/">계속 읽기</a>
</span>
</div>
<div class='tags'>
<i class='fa fa-tag'></i>
<a href='/tags/docker'>docker</a>
<i class='fa fa-tag'></i>
<a href='/tags/elasticsearch'>elasticsearch</a>
<i class='fa fa-tag'></i>
<a href='/tags/eunjeon'>eunjeon</a>
<i class='fa fa-tag'></i>
<a href='/tags/mecab'>mecab</a>
<i class='fa fa-tag'></i>
<a href='/tags/morphology'>morphology</a>
<i class='fa fa-tag'></i>
<a href='/tags/programming'>programming</a>
<i class='fa fa-tag'></i>
<a href='/tags/search_engine'>search_engine</a>
</div>
<div class='barcode' data-title='엘라스틱서치(elasticsearch)에 한글 형태소 분석기 은전한잎(eunjeon) 적용하기'></div>
</div>

</div>
<div class='nextnav'>
<a href='/articles/2015-08-29-link-deckset/' rel='next'>다음 글</a>
<div class='fa fa-chevron-right'></div>
<div class='fa fa-chevron-right'></div>
<div class='fa fa-chevron-right'></div>
<div class='summary_card'>
<div class='categories'>
<div class='category category-software-top' style='width: 50.0%'></div>
<div class='category category-editor-top' style='width: 50.0%'></div>
</div>
<h1 class='title'>
<a href="http://blog.remotty.com/blog/2015/08/26/deckset/">마크다운(Markdown) 기반 OSX 프레젠테이션 도구 덱셋(Deckset)</a>
</h1>
<div>
<span class='date'>
<a href='/tags/software' title='소프트웨어(software) 목록'>
<i class='fa fa-square-o' style='color: #7f7f7f'></i>
소프트웨어
</a>
<a href='/tags/editor' title='에디터(Editor) 목록'>
<i class='fa fa-edit' style='color: #9467bd'></i>
에디터
</a>
<i class='fa fa-calendar'></i>
2015년 08월 29일 발행
</span>
</div>
<div class='summary'>
<div class='title-image-wrapper'>
<img class="title-image" src="http://i.imgur.com/UUa3Jhb.jpg" />
</div>
<p>Deckset은 Markdown 기반 프레젠테이션 도구이다. Deckset은 따로 에디터 기능을 가지고 있지 않으면 자신이 선호하는 에디터로 Plain Text 포맷의 일종인 Markdown으로 문서를 작성하면 이를 슬라이드 형식이나 보여주거나 PDF로 변환할 수 있도록 도와주는 도구이다. 이를 통해 슬라이드 한 장 한 장의 디자인에 신경쓰기보다는 프레젠테이션의 내용에만 집중해서 슬라이드를 작성할 수 있게 도와준다.</p>

<span class='link'>
<a href="http://blog.remotty.com/blog/2015/08/26/deckset/">계속 읽기</a>
</span>
</div>
<div class='tags'>
<i class='fa fa-tag'></i>
<a href='/tags/deckset'>deckset</a>
<i class='fa fa-tag'></i>
<a href='/tags/editor'>editor</a>
<i class='fa fa-tag'></i>
<a href='/tags/markdown'>markdown</a>
<i class='fa fa-tag'></i>
<a href='/tags/mathjax'>mathjax</a>
<i class='fa fa-tag'></i>
<a href='/tags/osx'>osx</a>
<i class='fa fa-tag'></i>
<a href='/tags/plain_text'>plain_text</a>
<i class='fa fa-tag'></i>
<a href='/tags/presentation'>presentation</a>
<i class='fa fa-tag'></i>
<a href='/tags/software'>software</a>
</div>
<div class='barcode' data-title='마크다운(Markdown) 기반 OSX 프레젠테이션 도구 덱셋(Deckset)'></div>
</div>

</div>
<br style='clear:both'>
</div>
</div>
</div>
</div>
<div class='col-lg-2 col-md-2'></div>
</div>
<script>
  $('.toc').toc({
    'selectors': 'h2,h3,h4,h5',
    'container': '.article'
  });
</script>

<div class='row'>
<div class='col-lg-12'>
<hr>
<div class='site-footer'>
<div class='search-form'>
<form role="search" id="cse-search-box" action="http://google.com/cse">
<input type="hidden" name="cx" value="001442510316556568987:j38kphmalos" />
<input type="hidden" name="ie" value="UTF-8" />
<div class="form-group">
<input class="form-control" type="text" name="q" size="15" />
</div>
</form>
</div>
<div class='navigaiton'>
<a class='icon' href='/' title='블로그 메인으로 이동'>
<i class='fa-home fa fa-2x'></i>
</a>
<a class='icon' href='http://nacyot.com' title='nacyot.com'>
<i class='fa-user fa fa-2x'></i>
</a>
<a class='icon' href='https://twitter.com/nacyo_t' title='nacyo_t 트위터'>
<i class='fa-twitter fa fa-2x'></i>
</a>
<a class='icon' href='https://github.com/nacyot' title='nacyot Github'>
<i class='fa-github fa fa-2x'></i>
</a>
<a class='icon' href='/feed.xml' style='color: orange' title='nacyot의 프로그래밍 이야기 RSS feed'>
<i class='fa-rss fa fa-2x'></i>
</a>
</div>
<div class='copyright'>
<div>
All content copyright
<a href='http://nacyot.com'>nacyot</a>
© 2013-2015
</div>
<div></div>
All rights reserved.
</div>
</div>
</div>
</div>

</body>
</html>

